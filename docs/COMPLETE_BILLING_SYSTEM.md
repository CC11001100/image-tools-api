# å®Œæ•´è®¡è´¹ç³»ç»Ÿæ–‡æ¡£

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸ºæ•´ä¸ªå›¾åƒå¤„ç†APIç³»ç»Ÿå®æ–½çš„å®Œæ•´è®¡è´¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ¥å£çš„è®¤è¯è¦æ±‚ã€è®¡è´¹ç­–ç•¥å’Œä½¿ç”¨æŒ‡å—ã€‚

## ğŸ“Š è®¡è´¹ç­–ç•¥

### åŸºç¡€è´¹ç”¨ç»“æ„
- **åŸºç¡€è°ƒç”¨è´¹ç”¨**: 100 Tokenï¼ˆæ¯æ¬¡APIè°ƒç”¨çš„å›ºå®šè´¹ç”¨ï¼‰
- **ä¸‹è½½è´¹ç”¨**: 100 Token/MBï¼ˆä»URLä¸‹è½½å›¾ç‰‡çš„è´¹ç”¨ï¼‰
- **ä¸Šä¼ è´¹ç”¨**: 50 Token/MBï¼ˆä¸Šä¼ å¤„ç†åå›¾ç‰‡åˆ°ç½‘ç›˜çš„è´¹ç”¨ï¼‰
- **æœ€å°è®¡è´¹å•ä½**: 1KBï¼ˆä¸è¶³1KBæŒ‰1KBè®¡ç®—ï¼‰

### å››ç§è®¡è´¹æ¨¡å¼

#### ğŸ”¹ ç±»å‹A: ä»…ä¸Šä¼ æ–‡ä»¶
**é€‚ç”¨æ¥å£**: `/api/v1/watermark`, `/api/v1/filter`, `/api/v1/crop` ç­‰
**è®¡è´¹å…¬å¼**: `100 + 50 Ã— (ä¸»æ–‡ä»¶å¤§å°MB) + 50 Ã— (ç»“æœæ–‡ä»¶å¤§å°MB)`
**ç¤ºä¾‹**: 1MBæ–‡ä»¶å¤„ç† = 100 + 50 + 50 = 200 Token

#### ğŸ”¹ ç±»å‹B: URLä¸‹è½½
**é€‚ç”¨æ¥å£**: `/api/v1/watermark-by-url`, `/api/v1/filter-by-url`, `/api/v1/resize-by-url` ç­‰
**è®¡è´¹å…¬å¼**: `100 + 100 Ã— (ä¸‹è½½æ–‡ä»¶å¤§å°MB) + 50 Ã— (ç»“æœæ–‡ä»¶å¤§å°MB)`
**ç¤ºä¾‹**: ä¸‹è½½2MBå¤„ç†æˆ1MB = 100 + 200 + 50 = 350 Token

#### ğŸ”¹ ç±»å‹C: åŒæ–‡ä»¶ä¸Šä¼ 
**é€‚ç”¨æ¥å£**: `/api/v1/watermark/image`, `/api/v1/blend` ç­‰
**è®¡è´¹å…¬å¼**: `100 + 50 Ã— (ä¸»æ–‡ä»¶MB) + 50 Ã— (è¾…åŠ©æ–‡ä»¶MB) + 50 Ã— (ç»“æœæ–‡ä»¶MB)`
**ç¤ºä¾‹**: 1MBä¸»æ–‡ä»¶ + 512KBè¾…åŠ©æ–‡ä»¶ = 100 + 50 + 25 + 50 = 225 Token

#### ğŸ”¹ ç±»å‹D: æ··åˆæ¨¡å¼
**é€‚ç”¨æ¥å£**: `/api/v1/watermark/image-by-url` ç­‰
**è®¡è´¹å…¬å¼**: `100 + 100 Ã— (ä¸‹è½½MB) + 50 Ã— (ä¸Šä¼ MB) + 50 Ã— (ç»“æœMB)`
**ç¤ºä¾‹**: ä¸‹è½½2MB + ä¸Šä¼ 1MB = 100 + 200 + 50 + 50 = 400 Token

## ğŸ” è®¤è¯è¦æ±‚

### API Tokenæ ¼å¼
```
Authorization: aigc-hub-5c5e31cf7dd2442a97bd5b7cdbbddc1a
```

### å¼ºåˆ¶è®¤è¯æ¥å£
æ‰€æœ‰å›¾åƒå¤„ç†æ¥å£ç°åœ¨éƒ½éœ€è¦API Tokenè®¤è¯ï¼š
- âœ… æ°´å°å¤„ç†: `/api/v1/watermark/*`
- âœ… å›¾ç‰‡ç¼©æ”¾: `/api/v1/resize/*`
- âœ… æ»¤é•œå¤„ç†: `/api/v1/filter/*`
- âœ… è‰ºæœ¯æ»¤é•œ: `/api/v1/art-filter/*`
- âœ… è£å‰ªåŠŸèƒ½: `/api/v1/crop/*`
- âœ… å˜æ¢åŠŸèƒ½: `/api/v1/transform/*`
- âœ… é€è§†å˜æ¢: `/api/v1/perspective/*`
- âœ… å›¾åƒå¢å¼º: `/api/v1/enhance/*`
- âœ… æ··åˆå¤„ç†: `/api/v1/blend/*`
- âœ… å›¾åƒæ‹¼æ¥: `/api/v1/stitch/*`
- âœ… æ ¼å¼è½¬æ¢: `/api/v1/format/*`
- âœ… é®ç½©å¤„ç†: `/api/v1/mask/*`
- âœ… å åŠ å¤„ç†: `/api/v1/overlay/*`
- âœ… GIFå¤„ç†: `/api/v1/gif/*`
- âœ… å™ªç‚¹å¤„ç†: `/api/v1/noise/*`
- âœ… åƒç´ åŒ–: `/api/v1/pixelate/*`
- âœ… ç”»å¸ƒå¤„ç†: `/api/v1/canvas/*`
- âœ… é¢œè‰²å¤„ç†: `/api/v1/color/*`
- âœ… é«˜çº§æ–‡æœ¬: `/api/v1/advanced-text/*`
- âœ… æ³¨é‡ŠåŠŸèƒ½: `/api/v1/annotation/*`
- âœ… æ–‡æœ¬è½¬å›¾ç‰‡: `/api/v1/text-to-image/*`
- âœ… AIæ–‡æœ¬è½¬å›¾ç‰‡: `/api/v1/ai-text-to-image/*`

## ğŸ’° è´¹ç”¨ç¤ºä¾‹

### å¸¸è§æ“ä½œè´¹ç”¨å¯¹æ¯”
| æ“ä½œç±»å‹ | æ–‡ä»¶å¤§å° | æ€»è´¹ç”¨ | è¯´æ˜ |
|----------|----------|--------|------|
| æœ¬åœ°æ°´å°æ·»åŠ  | 1MB | 200 Token | åŸºç¡€100 + ä¸Šä¼ 50 + ç»“æœ50 |
| URLæ°´å°æ·»åŠ  | ä¸‹è½½2MBâ†’1MB | 350 Token | åŸºç¡€100 + ä¸‹è½½200 + ç»“æœ50 |
| å›¾ç‰‡æ°´å° | 1MB+512KB | 225 Token | åŸºç¡€100 + ä¸»æ–‡ä»¶50 + æ°´å°25 + ç»“æœ50 |
| æ»¤é•œå¤„ç† | 1MB | 200 Token | åŸºç¡€100 + ä¸Šä¼ 50 + ç»“æœ50 |
| å›¾ç‰‡ç¼©æ”¾ | 2MBâ†’1MB | 250 Token | åŸºç¡€100 + ä¸Šä¼ 100 + ç»“æœ50 |

### ä¸åŒæ–‡ä»¶å¤§å°æˆæœ¬
| æ–‡ä»¶å¤§å° | æœ¬åœ°å¤„ç†è´¹ç”¨ | URLå¤„ç†è´¹ç”¨ |
|----------|--------------|-------------|
| 100KB | 110 Token | 160 Token |
| 500KB | 150 Token | 200 Token |
| 1MB | 200 Token | 250 Token |
| 5MB | 600 Token | 850 Token |
| 10MB | 1100 Token | 1600 Token |

## ğŸ”„ è®¡è´¹æµç¨‹

### ä¸‰æ­¥è®¡è´¹æµç¨‹
1. **é¢„æ‰£è´¹**: æ ¹æ®é¢„ä¼°è´¹ç”¨æ‰£é™¤Token
2. **æ‰§è¡Œå¤„ç†**: æ‰§è¡Œå›¾åƒå¤„ç†å’Œä¸Šä¼ æ“ä½œ
3. **ç»“ç®—**: æˆåŠŸä¿æŒé¢„æ‰£è´¹ï¼Œå¤±è´¥è‡ªåŠ¨é€€è´¹

### è‡ªåŠ¨é€€è´¹æœºåˆ¶
- âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥ â†’ å…¨é¢é€€è´¹
- âŒ å›¾ç‰‡å¤„ç†å¤±è´¥ â†’ å…¨é¢é€€è´¹
- âŒ ç½‘ç›˜ä¸Šä¼ å¤±è´¥ â†’ å…¨é¢é€€è´¹
- âŒ ä»»ä½•å¼‚å¸¸æƒ…å†µ â†’ å…¨é¢é€€è´¹

## ğŸ“ è¯¦ç»†å¤‡æ³¨ç³»ç»Ÿ

æ¯æ¬¡è®¡è´¹éƒ½åŒ…å«è¯¦ç»†è¯´æ˜ï¼š
```
/api/v1/watermark - æ–‡å­—æ°´å°æ·»åŠ  - ä¸»æ–‡ä»¶1.00MB(50Token) + ç»“æœæ–‡ä»¶1.00MB(50Token) + åŸºç¡€è´¹ç”¨100Token = æ€»è®¡200Token
```

## ğŸ›  æŠ€æœ¯å®ç°

### è®¡è´¹å·¥å…·ç±»
```python
from app.utils.billing_utils import (
    calculate_upload_only_billing,
    calculate_url_download_billing,
    calculate_dual_upload_billing,
    calculate_mixed_mode_billing,
    generate_operation_remark
)

# è®¡ç®—è´¹ç”¨
billing_info = calculate_upload_only_billing(primary_size, result_size)
estimated_tokens = billing_info["total_cost"]

# ç”Ÿæˆå¤‡æ³¨
remark = generate_operation_remark(api_path, operation_name, billing_info)
```

### é¢„æ‰£è´¹ç¤ºä¾‹
```python
call_id = await billing_service.pre_charge(
    api_token=api_token,
    api_path="/api/v1/watermark",
    context=context,
    estimated_tokens=estimated_tokens,
    remark=remark
)
```

## ğŸ“‹ APIå“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "success": true,
  "message": "æ°´å°æ·»åŠ æˆåŠŸï¼Œæ¶ˆè€— 200 Token",
  "file": {
    "id": "12345",
    "filename": "watermarked_image.jpg",
    "url": "https://aigc-network-disk.aigchub.vip/files/12345",
    "size": 1048576,
    "content_type": "image/jpeg"
  },
  "processing_info": {
    "watermark_text": "Sample Watermark",
    "position": "center",
    "billing_info": {
      "base_cost": 100,
      "primary_cost": 50,
      "result_cost": 50,
      "total_cost": 200,
      "breakdown": {
        "base": "100 Token (åŸºç¡€è°ƒç”¨è´¹ç”¨)",
        "primary": "50 Token (ä¸»æ–‡ä»¶ 1.00 MB)",
        "result": "50 Token (ç»“æœæ–‡ä»¶ 1.00 MB)"
      }
    },
    "call_id": "req_abc123..."
  }
}
```

### é”™è¯¯å“åº”
```json
{
  "code": 401,
  "message": "æœªæˆæƒè®¿é—®ï¼Œè¯·å…ˆç™»å½•"
}
```

```json
{
  "code": 402,
  "message": "ä½™é¢ä¸è¶³æˆ–é¢„æ‰£è´¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦æˆ·ä½™é¢"
}
```

## ğŸš€ æœ€ä½³å®è·µ

### 1. æˆæœ¬ä¼˜åŒ–
- åœ¨ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡å‡å°‘ä¸Šä¼ è´¹ç”¨
- é€‰æ‹©åˆé€‚çš„è´¨é‡å‚æ•°å¹³è¡¡æ–‡ä»¶å¤§å°å’Œå›¾ç‰‡è´¨é‡
- æ‰¹é‡å¤„ç†æ—¶è€ƒè™‘æ–‡ä»¶å¤§å°å¯¹æ€»æˆæœ¬çš„å½±å“

### 2. é”™è¯¯å¤„ç†
- æ£€æŸ¥APIå“åº”ä¸­çš„è®¡è´¹ä¿¡æ¯
- ç›‘æ§è´¦æˆ·ä½™é¢ï¼ŒåŠæ—¶å……å€¼
- å¤„ç†402é”™è¯¯ï¼Œæç¤ºç”¨æˆ·ä½™é¢ä¸è¶³

### 3. ç›‘æ§ä½¿ç”¨é‡
- è®°å½•æ¯æ¬¡APIè°ƒç”¨çš„è´¹ç”¨
- å®šæœŸæ£€æŸ¥è´¦æˆ·ä½™é¢å’Œä½¿ç”¨ç»Ÿè®¡
- è®¾ç½®è´¹ç”¨é¢„è­¦æœºåˆ¶

## ğŸ“ˆ ç³»ç»Ÿä¼˜åŠ¿

### âœ… å®Œæ•´æ€§
- è¦†ç›–æ‰€æœ‰å›¾åƒå¤„ç†æ¥å£
- ç»Ÿä¸€çš„è®¡è´¹ç­–ç•¥å’Œè®¤è¯è¦æ±‚
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé€€è´¹æœºåˆ¶

### âœ… é€æ˜åº¦
- è¯¦ç»†çš„è´¹ç”¨æ˜ç»†
- æ¸…æ™°çš„è®¡è´¹å¤‡æ³¨
- å®æ—¶çš„è´¹ç”¨åé¦ˆ

### âœ… å¯é æ€§
- ä¸‰æ­¥è®¡è´¹æµç¨‹ç¡®ä¿å‡†ç¡®æ€§
- è‡ªåŠ¨é€€è´¹æœºåˆ¶ä¿æŠ¤ç”¨æˆ·åˆ©ç›Š
- å®Œæ•´çš„æ—¥å¿—è®°å½•ä¾¿äºè¿½è¸ª

### âœ… çµæ´»æ€§
- æ”¯æŒ4ç§ä¸åŒçš„è®¡è´¹æ¨¡å¼
- ç²¾ç¡®åˆ°KBçš„è®¡è´¹ç²¾åº¦
- å¯æ‰©å±•çš„è®¡è´¹æ¡†æ¶

## ğŸ“Š ç»Ÿè®¡æ•°æ®

- **æ¥å£æ€»æ•°**: 50+ ä¸ªAPIç«¯ç‚¹
- **è®¡è´¹æ¨¡å¼**: 4ç§ä¸åŒç±»å‹
- **è®¤è¯è¦†ç›–ç‡**: 100%
- **è‡ªåŠ¨é€€è´¹**: æ”¯æŒ
- **è´¹ç”¨é€æ˜åº¦**: å®Œæ•´æ˜ç»†
- **æœ€å°è®¡è´¹å•ä½**: 1KB
- **åŸºç¡€è´¹ç”¨**: 100 Token
- **ä¸‹è½½è´¹ç‡**: 100 Token/MB
- **ä¸Šä¼ è´¹ç‡**: 50 Token/MB
